(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{905:function(t,e,r){function n(t,e){return 0|Math.imul(t|=0,e|=0)}function o(t){return(t|=0)<<2}function _(t){return((t|=0)>>2|0)>>>0}function s(t){return((t|=0)>>5|0)>>>0}function i(t){return((t|=0)>>6|0)>>>0}function u(t){return((t|=0)/85-.012|0)>>>0}function l(t){return((t|=0)>>7|0)>>>0}function h(t,e,r){return r|=0,0|((t|=0)<(e|=0)?e:t>r?r:t)}function c(t){return 255&(0|t)}function p(t){return(0|(t|=0))<0?0|-t:0|t}var a,f,g,d,y,b=Math.imul||function(t,e){var r=65535&t,n=65535&e;return r*n+((t>>>16&65535)*n+r*(e>>>16&65535)<<16>>>0)|0},x=Math.round,w=Math.fround,k=function(t){return 0|b(0|(t|=0),0|t)},O=function(t){var e,r;if(0==(0|(t=(0|t)>>>0))||1==(0|t))return 0|t;for(e=1,r=1;(0|r)<=(0|t);)r=((e=(e+1|0)>>>0)*e|0)>>>0;return(e-1|0)>>>0},P=w(1.08),j=w(1.32),m=w(.2*3),v=w(1.185),A=w(.107),U=w(.112),M=(0|O(255*P*255+255*j*255+255*m*255|0))>>>0,z=(255*P+255*j+255*m|0)>>>0,J=new Uint8Array(4),L=new Float32Array(2),Q=function F(t,e){if(!(this instanceof F))return new F(t,e);var r,n;e|=0,this.storage_uint8_=new Uint8Array(t,o(e),function(t,e){return 0|((0|(t|=0))>(0|(e|=0))?t:0)}(function(t,e){return 0|((0|(t|=0))>(0|(e|=0))?e:4)}(4,(r=t.byteLength,n=o(e),(r|=0)-(n|=0)|0)),0))};Object.defineProperty(Q.prototype,"r",{get:function(){return c(this.storage_uint8_[3])}}),Object.defineProperty(Q.prototype,"g",{get:function(){return c(this.storage_uint8_[2])}}),Object.defineProperty(Q.prototype,"b",{get:function(){return c(this.storage_uint8_[1])}}),Object.defineProperty(Q.prototype,"a",{get:function(){return c(this.storage_uint8_[0])}}),Object.defineProperty(Q.prototype,"uint32",{get:function(){return(this.storage_uint8_[3]<<24|this.storage_uint8_[2]<<16|this.storage_uint8_[1]<<8|this.storage_uint8_[0])>>>0}}),Object.defineProperty(Q.prototype,"rgbaon4bits",{get:function(){return(l(this.storage_uint8_[3])<<3|l(this.storage_uint8_[2])<<2|l(this.storage_uint8_[1])<<1|l(this.storage_uint8_[0])<<0|0)>>>0}}),Object.defineProperty(Q.prototype,"rgbaon6bits",{get:function(){return((16^u(this.storage_uint8_[3]))+(8^u(this.storage_uint8_[2]))+(4^u(this.storage_uint8_[1]))+(0^u(this.storage_uint8_[0]))|0)>>>0}}),Object.defineProperty(Q.prototype,"rgbaon8bits",{get:function(){return(i(this.storage_uint8_[3])<<6|i(this.storage_uint8_[2])<<4|i(this.storage_uint8_[1])<<2|i(this.storage_uint8_[0])<<0|0)>>>0}}),Object.defineProperty(Q.prototype,"rgbaon12bits",{get:function(){return(s(this.storage_uint8_[3])<<9|s(this.storage_uint8_[2])<<6|s(this.storage_uint8_[1])<<3|s(this.storage_uint8_[0])<<0|0)>>>0}}),Object.defineProperty(Q.prototype,"offset",{get:function(){return _(this.storage_uint8_.byteOffset)}}),Object.defineProperty(Q.prototype,"buffer",{get:function(){return this.storage_uint8_.buffer.slice(this.storage_uint8_.byteOffset,(t=this.storage_uint8_.byteOffset,e=4,((t|=0)+(e|=0)|0)>>>0));var t,e}}),Object.defineProperty(Q.prototype,"subarray",{get:function(){return this.storage_uint8_.subarray(0,4)}}),Object.defineProperty(Q.prototype,"skin",{get:function(){var t,e=(this.b+this.g+this.r|0)>>>0;return(0|e)>0&&(J[0]=h((3*this.r|0)/e|0,0,255),J[1]=h((3*this.g|0)/e|0,0,255),J[2]=h((3*this.b|0)/e|0,0,255),t=k((J[0]+J[1]+J[2]|0)>>>0|0)>>>0,w(J[0]/J[1])>v&&w(((J[0]*J[2]|0)>>>0)/t)>A&&w(((J[0]*J[1]|0)>>>0)/t)>U)}}),Object.defineProperty(Q.prototype,"set_from_array",{get:function(){return function(t){this.storage_uint8_[0]=c(t[0]),this.storage_uint8_[1]=c(t[1]),this.storage_uint8_[2]=c(t[2]),this.storage_uint8_[3]=c(t[3])}}}),Object.defineProperty(Q.prototype,"slice",{get:function(){return function(t,e){return this.storage_uint8_.slice(t,e)}}}),Object.defineProperty(Q.prototype,"simplify",{get:function(){return function(t){t=w(t),this.storage_uint8_[0]=h(n(x(this.a/t),t),0,255),this.storage_uint8_[1]=h(n(x(this.b/t),t),0,255),this.storage_uint8_[2]=h(n(x(this.g/t),t),0,255),this.storage_uint8_[3]=h(n(x(this.r/t),t),0,255)}}}),Q.blend_all=function(t,e,r){for(var n,o=0|t.r,_=0|t.g,s=0|t.b,i=0|t.a,u=w(1),l=w(0),c=0|e.length,p=0;(0|p)<(0|c);p=p+1|0)n=e[0|p],l=w(r[0|p]),u=w(u+l),i=(i+n.a*l|0)>>>0,s=(s+n.b*l|0)>>>0,_=(_+n.g*l|0)>>>0,o=(o+n.r*l|0)>>>0;for(J[0]=h(x(i/u),0,255),J[1]=h(x(s/u),0,255),J[2]=h(x(_/u),0,255),J[3]=h(x(o/u),0,255),t.set_from_array(J),p=0;(0|p)<(0|c);p=p+1|0)e[0|p].set_from_array(J)},Q.prototype.euclidean_match_with=function(t,e){return e=w(e),L[0]=w(1-p(this.a-t.a|0)/255),L[1]=w(L[0]*L[0]),w(O(P*k(this.r-t.r|0)+j*k(this.g-t.g|0)+m*k(this.b-t.b|0)|0)/M)<w(e*L[1])},Q.prototype.manhattan_match_with=function(t,e){return e=w(e),L[0]=w(1-p(this.a-t.a|0)/255),L[1]=w(L[0]*L[0]),w((P*p(this.r-t.r|0)+j*p(this.g-t.g|0)+m*p(this.b-t.b|0)|0)/z)<w(e*L[1])},Q.prototype.copy=function(t){return Q(this.slice(0,4))},Object.defineProperty((a=function G(t,e,r){if(!(this instanceof G))return new G(t);this.storage_="buffer"in t?t.buffer:t,e|=0,r=0|r||0|this.storage_.byteLength,this.storage_uint32_array_=new Uint32Array(this.storage_,e,_(r))}).prototype,"length",{get:function(){return this.storage_uint32_array_.length}}),Object.defineProperty(a.prototype,"buffer",{get:function(){return this.storage_uint32_array_.buffer}}),Object.defineProperty(a.prototype,"buffer_getUint32",{get:function(){return function(t){return this.storage_uint32_array_[0|t]}}}),Object.defineProperty(a.prototype,"slice_uint32",{get:function(){return function(t,e){return t|=0,e=(e|=0)||this.length,this.storage_uint32_array_.slice(t,e)}}}),a.prototype.get_element=function(t){return Q(this.buffer,0|t)},f=w(.333),g=w(.666),Object.defineProperty((d=function q(t){if(t=t||{},!(this instanceof q))return new q(t);t.pxl_colors=t.pxl_colors||new Uint32Array(0),t.pxls=t.pxls||new Uint32Array(0),this.new_pxls_="buffer"in t.pxls?new Uint32Array(t.pxls.buffer):Uint32Array.from(t.pxls),this.new_pxl_colors_="buffer"in t.pxl_colors?a(t.pxl_colors.buffer):a(Uint32Array.from(t.pxl_colors));var e=0|this.new_pxl_colors_.length;this.new_pxl_colors_is_skin_mask_=new Uint8Array(0|e),this.is_bucket_threshold_auto_=!!(t.bucket_threshold>4096),t.bucket_threshold=t.bucket_threshold||0,t.bucket_threshold=(0|t.bucket_threshold)>=1?0|t.bucket_threshold:(4096*t.bucket_threshold|0)>=1?4096*t.bucket_threshold|0:t.this_state_bucket_threshold||96,this.set_new_pxl_skin_mask(),this.bucket_threshold_=this.is_bucket_threshold_auto_?1:t.bucket_threshold,this.threshold_steps_=this.is_bucket_threshold_auto_||e>16384?1:e>8192?2:e>2048?3:e>512?4:5,this.best_color_number_=e/2+t.color_number_bonus|0,this.max_cluster_=e>16384?4097:e>8192?257:e>2048?65:e>512?17:1,this.index_clusters_=Array(this.max_cluster_),this.length_clusters_=new Uint32Array(this.max_cluster_),this.pxl_colors_usage_=new Uint32Array(e),this.all_index_clusters_=new Uint32Array(e),this.clean_pxl_colors_=new Uint32Array(e),this.clean_pxl_colors_lookup_={}}).prototype,"reset_deduplicate",{get:function(){return function(t){this.clean_pxl_colors_lookup_={},this.pxl_colors_usage_.fill(0,0,0|t),this.clean_pxl_colors_.fill(0,0,0|t)}}}),Object.defineProperty(d.prototype,"index_of_color_within_cleaned",{get:function(){return function(t){return(0|this.clean_pxl_colors_lookup_[(0|t)>>>0])-1|0}}}),Object.defineProperty(d.prototype,"set_cleaned_pxl_colors",{get:function(){return function(t,e){this.clean_pxl_colors_[(0|t)>>>0]=(0|e)>>>0,this.clean_pxl_colors_lookup_[(0|e)>>>0]=(t+1|0)>>>0}}}),Object.defineProperty(d.prototype,"increase_color_usage",{get:function(){return function(t){this.pxl_colors_usage_[(0|t)>>>0]=(this.pxl_colors_usage_[(0|t)>>>0]+1|0)>>>0}}}),Object.defineProperty(d.prototype,"set_new_pxls",{get:function(){return function(t,e){this.new_pxls_[(0|t)>>>0]=(0|e)>>>0}}}),Object.defineProperty(d.prototype,"set_new_pxl_colors",{get:function(){return function(t){this.new_pxl_colors_=a(this.clean_pxl_colors_.buffer.slice(0,o(0|t))),this.set_new_pxl_skin_mask()}}}),Object.defineProperty(d.prototype,"set_new_pxl_skin_mask",{get:function(){return function(){var t,e=0|this.new_pxl_colors_.length;for(this.new_pxl_colors_is_skin_mask_=new Uint8Array(0|e),t=0;(0|t)<(0|e);t=t+1|0)this.new_pxl_colors_.get_element(0|t).skin&&(this.new_pxl_colors_is_skin_mask_[0|t]=0)}}}),Object.defineProperty(d.prototype,"get_a_new_pxl_color_from_pxl_index",{get:function(){return function(t){return 4294967295&this.new_pxl_colors_.buffer_getUint32(this.new_pxls_[0|t])}}}),Object.defineProperty(d.prototype,"reset_cluster",{get:function(){return function(){this.max_cluster_=this.new_pxl_colors_.length>16384?4097:this.new_pxl_colors_.length>8192?257:this.new_pxl_colors_.length>2048?65:this.new_pxl_colors_.length>512?17:1,this.length_clusters_.fill(0,0,0|this.max_cluster);for(var t=0;(0|t)<(0|this.max_cluster);t=(t+1|0)>>>0)this.index_clusters_[0|t]=[]}}}),Object.defineProperty(d.prototype,"add_in_indexes_cluster",{get:function(){return function(t,e){this.index_clusters_[(0|t)>>>0].push((0|e)>>>0)}}}),Object.defineProperty(d.prototype,"set_all_cluster_indexes",{get:function(){return function(){var t=0,e=0;for(t=0;(0|t)<(0|this.max_cluster);t=(t+1|0)>>>0)this.all_index_clusters_.set(this.index_clusters_[(0|t)>>>0],(0|e)>>>0),e=(e+this.get_length_in_index_clusters(0|t)|0)>>>0}}}),Object.defineProperty(d.prototype,"get_length_in_index_clusters",{get:function(){return function(t){return(0|this.index_clusters_[(0|t)>>>0].length)>>>0}}}),Object.defineProperty(d.prototype,"get_in_cluster_lengths",{get:function(){return function(t){return(0|this.length_clusters_[(0|t)>>>0])>>>0}}}),Object.defineProperty(d.prototype,"get_an_index_in_clusters",{get:function(){return function(t){return(0|this.all_index_clusters_[0|t])>>>0}}}),Object.defineProperty(d.prototype,"get_a_color_usage",{get:function(){return function(t){return(0|this.pxl_colors_usage_[0|t])>>>0}}}),Object.defineProperty(d.prototype,"set_a_color_usage",{get:function(){return function(t,e){return this.pxl_colors_usage_[0|t]=(0|e)>>>0}}}),Object.defineProperty(d.prototype,"get_a_color_usage_percent",{get:function(){return function(t){return this.pxl_colors_usage_[0|t]/this.new_pxls_.length}}}),Object.defineProperty(d.prototype,"get_average_color_usage_percent",{get:function(){return function(t,e){var r,n,o;for(e=0|((e|=0)<(t|=0)?this.pxl_colors_usage_.length:e),r=0,n=0,o=0,n=0|t;(0|n)<(0|e);n=(n+1|0)>>>0)o=(0|this.get_an_index_in_clusters((0|n)>>>0))>>>0,r+=this.pxl_colors_usage_[0|o]/this.new_pxls_.length;return r/(e-t|0)}}}),Object.defineProperty(d.prototype,"get_a_new_pxl_color",{get:function(){return function(t){return this.new_pxl_colors_.get_element(0|t)}}}),Object.defineProperty(d.prototype,"is_pxl_color_skin",{get:function(){return function(t){return(0|this.new_pxl_colors_is_skin_mask_[0|t])>0}}}),Object.defineProperty(d.prototype,"max_cluster",{get:function(){return 0|this.max_cluster_}}),Object.defineProperty(d.prototype,"threshold_steps",{get:function(){return 0|this.threshold_steps_}}),Object.defineProperty(d.prototype,"new_pxls_length",{get:function(){return 0|this.new_pxls_.length}}),Object.defineProperty(d.prototype,"new_pxl_colors_length",{get:function(){return 0|this.new_pxl_colors_.length}}),Object.defineProperty(d.prototype,"best_color_number",{get:function(){return 0|this.best_color_number_}}),Object.defineProperty(d.prototype,"bucket_threshold",{get:function(){return 0|this.bucket_threshold_}}),Object.defineProperty(d.prototype,"is_bucket_threshold_auto",{get:function(){return this.is_bucket_threshold_auto_}}),Object.defineProperty(d.prototype,"set_bucket_threshold",{get:function(){return function(t){this.bucket_threshold_=0|t}}}),Object.defineProperty(d.prototype,"get_data",{get:function(){return function(){return Array.of(this.new_pxls_,this.new_pxl_colors_.slice_uint32(0,this.new_pxl_colors_.length))}}}),d.prototype.output=function(t){var e,r;return t=t||"heap",e=this.get_data(),"heap"==t?((r=new Uint32Array(2+e[0].length+e[1].length))[0]=0|e[0].length,r[1]=0|e[1].length,r.set(e[0],2),r.set(e[1],2+e[0].length),r.buffer):e},d.prototype.deduplicate=function(){var t,e,r,n,o;for(this.reset_deduplicate(0|this.new_pxl_colors_length),t=0,e=0,r=0,n=0,o=0|this.new_pxls_length;(0|n)<(0|o);n=(n+1|0)>>>0)e=0|this.get_a_new_pxl_color_from_pxl_index(0|n),-1==(0|(r=0|this.index_of_color_within_cleaned(0|e)))&&(this.set_cleaned_pxl_colors(0|t,0|e),r=0|t,t=t+1|0),this.increase_color_usage(0|r),this.set_new_pxls(0|n,0|r);this.set_new_pxl_colors(t)},d.prototype.clusterize=function(){this.reset_cluster();var t=0;if(4097===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon12bits)>>>0,(0|t)>>>0);else if(257===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon8bits)>>>0,(0|t)>>>0);else if(65===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon6bits)>>>0,(0|t)>>>0);else if(17===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon4bits)>>>0,(0|t)>>>0);else if(1===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster(0,(0|t)>>>0);this.set_all_cluster_indexes()},d.prototype.process_threshold=function(t){var e,r,n,o,_,s,i,u,l,h,c,p,a,d,y,b,x,k,O,P,j,m;for(t=(0|t)>>>0,e=this.bucket_threshold*(t/this.threshold_steps)|0,r=w(t/this.threshold_steps),n=!1,o=[],_=[],s=0,i=0,h=!1,c=!1,p=0,a=0,d=0,k=0,O=0,P=0,j=0,m=0,y=w(w(e/4096+e/4096*r)/w(1+r)),x=w(y*g),b=w(y*f);(0|m)<(0|this.max_cluster);m=(m+1|0)>>>0){for(i=(s+((0|this.get_length_in_index_clusters(0|m))>>>0)|0)>>>0,P=0|s;(0|P)<(0|i);P=(P+1|0)>>>0){if(k=(0|this.get_an_index_in_clusters((0|P)>>>0))>>>0,u=this.get_a_new_pxl_color((0|k)>>>0),h=this.is_pxl_color_skin((0|k)>>>0),(0|(p=(0|this.get_a_color_usage((0|k)>>>0))>>>0))>0)for(o=[],j=0|s;(0|j)<(0|i);j=(j+1|0)>>>0)O=(0|this.get_an_index_in_clusters((0|j)>>>0))>>>0,l=this.get_a_new_pxl_color((0|O)>>>0),c=this.is_pxl_color_skin((0|O)>>>0),(0|(a=(0|this.get_a_color_usage((0|O)>>>0))>>>0))>0&&(0|k)!=(0|O)&&u.euclidean_match_with(l,h&&c?x:h||c?b:y)&&(d=w(a/p),n=!0,this.set_a_color_usage(0|O,0),o.push(l),_.push(d));(0|o.length)>0&&(Q.blend_all(u,o,_),o=[],_=[])}s=0|i}return n},d.prototype.round=function(){var t,e;if(this.new_pxl_colors_length>512)for(t=this.new_pxl_colors_.length>16384?16:this.new_pxl_colors_.length>8192?8:this.new_pxl_colors_.length>2048?4:this.new_pxl_colors_.length>512?2:1,e=0;(0|e)<(0|this.new_pxl_colors_length);e=(e+1|0)>>>0)this.get_a_new_pxl_color((0|e)>>>0).simplify(t)},d.prototype.init=function(){return this.round(),this.deduplicate(),this.clusterize(),this},d.prototype.run=function(){for(var t,e=!1;!e;){for(t=1;(0|t)<=(0|this.threshold_steps);t=(t+1|0)>>>0)this.process_threshold(0|t)&&(this.deduplicate(),this.clusterize());if(!this.is_bucket_threshold_auto&&this.bucket_threshold>this.threshold_steps)e=!0;else if(this.new_pxl_colors_length<this.best_color_number)break;this.set_bucket_threshold(this.bucket_threshold+12|0)}return this},y=function(t,e,r,n,o,_){return new Promise((function(s){var i,u,l,h,c,p,a,f=new Uint32Array(t.data.subarray(0,t.data.length).reverse().buffer).reverse(),g=1,y=new Uint32Array(f.length),b=new Uint32Array(f.length);for(i=0,u=-1;(0|i)<(0|f.length);i=(i+1|0)>>>0,u=0|y.indexOf(0|f[0|i]))-1==(0|u)&&(y[0|g]=0|f[0|i],u=(0|g)>>>0,g=(g+1|0)>>>0),b[0|i]=(0|u)>>>0;for(c=0|(h=(l=d({pxls:b,pxl_colors:y.slice(0,g),bucket_threshold:e,threshold_steps:r,color_number_bonus:n,best_color_number:o,this_state_bucket_threshold:_,width:t.width,height:t.height}).init().run().output("split"))[0]).length,p=h.length-1|0,a=l[1],b=new Uint32Array(c),i=0;(0|i)<(0|c);i=(i+1|0)>>>0)b[p-i|0]=(0|a[0|h[0|i]])>>>0;t.data.set(new Uint8Array(b.buffer).reverse()),s(t)}))},t.exports={QuantiMatGlobal:y,QuantiMat:d}}}]);