
import {QuantiMatGlobal} from "./QuantiMat";

const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
window.quant_process_function = new AsyncFunction(`var t=function(t,e,r,n,o,_){"use strict";var i=.3125,s=.5154,u=.1721,l=(0|Math.sqrt(130050))>>>0;function h(t,e){return(t+e|0)>>>0}function c(t,e){return(t*e|0)>>>0}function a(t){return t<<2}function p(t,e){return(t/e|0)>>>0}function f(t){return(t>>2|0)>>>0}function g(t){return 255&(0|t)}function y(t){return 255&(255-t|0)}function d(t){return 255&(t/255|0)}function b(t){return(0|t)<0?(0|-t)>>>0:(0|t)>>>0}var x=function(t,e){if(e=e||0,!(this instanceof x))return new x(t,e);t instanceof Uint8ClampedArray?this.storage_uint8_=t:this.storage_uint8_=new Uint8ClampedArray("buffer"in t?t.buffer:t,c(e,4))};x.new_of=function(t,e,r,n){var o=new Uint8ClampedArray(4);return o[3]=g(t),o[2]=g(e),o[1]=g(r),o[0]=g(n),x(o)},Object.defineProperty(x.prototype,"r",{get:function(){return g(this.storage_uint8_[3])}}),Object.defineProperty(x.prototype,"g",{get:function(){return g(this.storage_uint8_[2])}}),Object.defineProperty(x.prototype,"b",{get:function(){return g(this.storage_uint8_[1])}}),Object.defineProperty(x.prototype,"a",{get:function(){return g(this.storage_uint8_[0])}}),Object.defineProperty(x.prototype,"uint32",{get:function(){return(this.storage_uint8_[3]<<24|this.storage_uint8_[2]<<16|this.storage_uint8_[1]<<8|this.storage_uint8_[0])>>>0}}),Object.defineProperty(x.prototype,"rgbaon4bits",{get:function(){return(f(f(f(f(this.storage_uint8_[3]))))<<3|f(f(f(f(this.storage_uint8_[2]))))<<2|f(f(f(f(this.storage_uint8_[1]))))<<1|f(f(f(f(this.storage_uint8_[0]))))<<0|0)>>>0}}),Object.defineProperty(x.prototype,"rgbaon8bits",{get:function(){return(f(f(f(this.storage_uint8_[3])))<<6|f(f(f(this.storage_uint8_[2])))<<4|f(f(f(this.storage_uint8_[1])))<<2|f(f(f(this.storage_uint8_[0])))<<0|0)>>>0}}),Object.defineProperty(x.prototype,"rgbaon12bits",{get:function(){return(p(f(f(this.storage_uint8_[3])),2)<<9|p(f(f(this.storage_uint8_[2])),2)<<6|p(f(f(this.storage_uint8_[1])),2)<<3|p(f(f(this.storage_uint8_[0])),2)<<0|0)>>>0}}),Object.defineProperty(x.prototype,"offset",{get:function(){return f(this.storage_uint8_.byteOffset)}}),Object.defineProperty(x.prototype,"buffer",{get:function(){return this.storage_uint8_.buffer.slice(this.storage_uint8_.byteOffset,h(this.storage_uint8_.byteOffset,4))}}),Object.defineProperty(x.prototype,"set",{get:function(){return function(t){t instanceof x?(this.storage_uint8_[3]=g(t.r),this.storage_uint8_[2]=g(t.g),this.storage_uint8_[1]=g(t.b),this.storage_uint8_[0]=g(t.a)):"subarray"in t?(this.storage_uint8_[3]=g(t[3]),this.storage_uint8_[2]=g(t[2]),this.storage_uint8_[1]=g(t[1]),this.storage_uint8_[0]=g(t[0])):"slice"in t?this.storage_uint8_.set(t.slice(0,4)):this.storage_uint8_.set(t)}}}),Object.defineProperty(x.prototype,"subarray",{get:function(){return function(t,e){return this.storage_uint8_.subarray(t,e)}}}),Object.defineProperty(x.prototype,"slice",{get:function(){return function(t,e){return this.storage_uint8_.slice(t,e)}}}),x.prototype.is_fully_transparent=function(){return(0|this.a)>>>0==(0|0)>>>0},x.prototype.simplify=function(t){var e=Uint8ClampedArray.of(c(Math.round(this.a/t),t),c(Math.round(this.b/t),t),c(Math.round(this.g/t),t),c(Math.round(this.r/t),t));return this.set(e),this},x.prototype.blend_with=function(t,e,r,n){if(e=g(e),n|=0,t.multiply_a_255(e),r){if(this.is_fully_transparent())return t.set(this),this;if(t.is_fully_transparent())return this.set(t),this}var o=(0|n)>0?p(h(this.a,t.a),2):y(d(c(y(t.a),y(this.a))));return this.set(x.merge_scale_of_255_a_fixed(t,p(c(t.a,255),o),this,d(c(this.a,p(c(y(t.a),255),o))),o)),t.set(this),this},x.prototype.euclidean_match_with=function(t,e){return 255==(0|(e=(0|e)>>>0))||(0==(0|e)?(0|this.uint32)==(0|t.uint32):(Math.sqrt(i*Math.pow(this.r-t.r|0,2)+s*Math.pow(this.g-t.g|0,2)+u*Math.pow(this.b-t.b|0,2)+1*Math.pow(this.a-t.a|0,2))/l*255|0)<(0|e))},x.prototype.manhattan_match_with=function(t,e){return 255==(0|(e=(0|e)>>>0))||(0==(0|e)?(0|this.uint32)==(0|t.uint32):((i*b(this.r-t.r|0)+s*b(this.g-t.g|0)+u*b(this.b-t.b|0)+1*b(this.a-t.a|0)|0)/510*255|0)<(0|e))},x.prototype.multiply_a_255=function(t){var e=this.subarray();return e[0]=g(d(c(e[0],t))),this},x.prototype.copy=function(){return x(this.slice(0,4))},x.with_a=function(t,e){var r=t.slice(0,4);return r[0]=g(e),x(r)},x.merge_scale_of_255=function(t,e,r,n){return x.merge(x.scale_of_on_255(t,e,e,e,e),x.scale_of_on_255(r,n,n,n,n))},x.merge_scale_of_255_a_fixed=function(t,e,r,n,o){return e=g(e),n=g(n),o=g(o),x.merge_with_a_fixed(x.scale_rgb_of_on_255(t,e,e,e),x.scale_rgb_of_on_255(r,n,n,n),o)},x.scale_of_on_255=function(t,e,r,n,o){return x(Uint8ClampedArray.of(d(c(t.a,o)),d(c(t.b,n)),d(c(t.g,r)),d(c(t.r,e))))},x.scale_rgb_of_on_255=function(t,e,r,n){return x(Uint8ClampedArray.of(0,d(c(t.b,n)),d(c(t.g,r)),d(c(t.r,e))))},x.merge=function(t,e){return x(Uint8ClampedArray.of(h(t.a,e.a),h(t.b,e.b),h(t.g,e.g),h(t.r,e.r)))},x.merge_with_a_fixed=function(t,e,r){return x(Uint8ClampedArray.of(g(r),h(t.b,e.b),h(t.g,e.g),h(t.r,e.r)))};var w=function(t,e,r){if(!(this instanceof w))return new w(t);this.storage_="buffer"in t?t.buffer:t,e|=0,r=0|r||0|this.storage_.byteLength,this.storage_uint8_array_=new Uint8Array(this.storage_,e,r),this.storage_uint32_array_=new Uint32Array(this.storage_,e,f(r))};Object.defineProperty(w.prototype,"length",{get:function(){return this.storage_uint32_array_.length}}),Object.defineProperty(w.prototype,"buffer",{get:function(){return this.storage_uint8_array_.buffer}}),Object.defineProperty(w.prototype,"buffer_setUint8",{get:function(){return function(t,e){return t|=0,e|=0,this.storage_uint8_array_[t]=g(e)}}}),Object.defineProperty(w.prototype,"buffer_getUint8",{get:function(){return function(t){return t|=0,this.storage_uint8_array_[t]}}}),Object.defineProperty(w.prototype,"buffer_getUint8a",{get:function(){return function(t,e){return e=h(t|=0,a(e=(e|=0)||1)),this.storage_uint8_array_.subarray(t,e)}}}),Object.defineProperty(w.prototype,"buffer_setUint32",{get:function(){return function(t,e){this.storage_uint32_array_[0|t]=function(t){return(0|t)>>>0&4294967295}(e)}}}),Object.defineProperty(w.prototype,"buffer_getUint32",{get:function(){return function(t){return this.storage_uint32_array_[0|t]}}}),Object.defineProperty(w.prototype,"subarray_uint32",{get:function(){return function(t,e){return t|=0,e=(e|=0)||this.length,this.storage_uint32_array_.subarray(t,e)}}}),Object.defineProperty(w.prototype,"slice_uint32",{get:function(){return function(t,e){return t|=0,e=(e|=0)||this.length,this.storage_uint32_array_.slice(t,e)}}}),Object.defineProperty(w.prototype,"subarray_uint8",{get:function(){return function(t,e){return t|=0,e|=0,this.storage_uint8_array_.subarray(a(t),a(e))}}}),Object.defineProperty(w.prototype,"slice_uint8",{get:function(){return function(t,e){return t|=0,e|=0,this.storage_uint8_array_.slice(a(t),a(e))}}}),w.prototype.get_element=function(t){return x(this.buffer,0|t)},w.prototype.subarray=function(t,e){return t|=0,e|=0,this.buffer_getUint8a(t,e)};var m=function(t){if(t=t||{},!(this instanceof m))return new m(t);t.pxl_colors=t.pxl_colors||new Uint32Array(0),t.pxls=t.pxls||new Uint32Array(0),this.bucket_threshold_auto_goal_target_=1,this.is_bucket_threshold_auto_=Boolean("auto"===t.bucket_threshold),this.this_state_bucket_threshold_=t.this_state_bucket_threshold||0,t.bucket_threshold=t.bucket_threshold||0,t.bucket_threshold=(255*t.bucket_threshold|0)>=1?255*t.bucket_threshold|0:255*this.this_state_bucket_threshold_|0,this.bucket_threshold_=0|(this.is_bucket_threshold_auto_?this.bucket_threshold_auto_goal_target_:t.bucket_threshold),this.threshold_steps_=t.threshold_steps||1,this.color_number_bonus_=0|t.color_number_bonus,this.best_color_number_=null!==t.best_color_number?t.best_color_number:Math.max(Math.sqrt(t.pxl_colors.length)+this.color_number_bonus_,100),this.new_pxls_="buffer"in t.pxls?new Uint32Array(t.pxls.buffer):Uint32Array.from(t.pxls),this.new_pxl_colors_="buffer"in t.pxl_colors?w(t.pxl_colors.buffer):w(Uint32Array.from(t.pxl_colors)),this.max_cluster_length_=0,this.max_cluster_=0,this.index_clusters_=new Array(2048),this.length_clusters_=new Uint32Array(2048),this.pxl_colors_usage_=new Uint32Array(this.new_pxl_colors_.length),this.all_index_clusters_=new Uint32Array(this.new_pxl_colors_.length),this.clean_pxl_colors_=new Uint32Array(this.new_pxl_colors_.length),this.clean_pxl_colors_lookup_=new Map};return Object.defineProperty(m.prototype,"reset_deduplicate",{get:function(){return function(t){this.pxl_colors_usage_.fill(0,0,0|t),this.clean_pxl_colors_lookup_.clear(),t===this.clean_pxl_colors_.length?this.clean_pxl_colors_.fill(0):this.clean_pxl_colors_=new Uint32Array(0|t)}}}),Object.defineProperty(m.prototype,"index_of_color_within_cleaned",{get:function(){return function(t){return 0|(this.clean_pxl_colors_lookup_.get((0|t)>>>0)||-1)}}}),Object.defineProperty(m.prototype,"set_cleaned_pxl_colors",{get:function(){return function(t,e){this.clean_pxl_colors_[(0|t)>>>0]=(0|e)>>>0,this.clean_pxl_colors_lookup_.set((0|e)>>>0,(0|t)>>>0)}}}),Object.defineProperty(m.prototype,"increase_color_usage",{get:function(){return function(t){this.pxl_colors_usage_[(0|t)>>>0]=(this.pxl_colors_usage_[(0|t)>>>0]+1|0)>>>0}}}),Object.defineProperty(m.prototype,"set_new_pxls",{get:function(){return function(t,e){this.new_pxls_[(0|t)>>>0]=(0|e)>>>0}}}),Object.defineProperty(m.prototype,"set_new_pxl_colors",{get:function(){return function(t){this.new_pxl_colors_=w(this.clean_pxl_colors_.buffer.slice(0,a(0|t)))}}}),Object.defineProperty(m.prototype,"get_a_new_pxl_color_from_pxl_index",{get:function(){return function(t){return 0|this.new_pxl_colors_.buffer_getUint32(this.new_pxls_[0|t])}}}),Object.defineProperty(m.prototype,"reset_cluster",{get:function(){return function(){this.max_cluster_=this.new_pxl_colors_.length>2048?4097:this.new_pxl_colors_.length>1024?257:this.new_pxl_colors_.length>512?17:1,this.length_clusters_.fill(0,0,this.max_cluster);for(var t=0;(0|t)<(0|this.max_cluster);t=(t+1|0)>>>0)this.index_clusters_[0|t]=[]}}}),Object.defineProperty(m.prototype,"add_in_indexes_cluster",{get:function(){return function(t,e){this.index_clusters_[(0|t)>>>0].push((0|e)>>>0)}}}),Object.defineProperty(m.prototype,"set_all_cluster_indexes",{get:function(){return function(){var t=0,e=0;for(t=0;(0|t)<(0|this.max_cluster);t=(t+1|0)>>>0)this.all_index_clusters_.set(this.index_clusters_[(0|t)>>>0],e),e=e+this.get_length_in_index_clusters(0|t)|0}}}),Object.defineProperty(m.prototype,"get_length_in_index_clusters",{get:function(){return function(t){return 0|this.index_clusters_[(0|t)>>>0].length}}}),Object.defineProperty(m.prototype,"get_in_cluster_lengths",{get:function(){return function(t){return(0|this.length_clusters_[(0|t)>>>0])>>>0}}}),Object.defineProperty(m.prototype,"get_an_index_in_clusters",{get:function(){return function(t){return 0|this.all_index_clusters_[0|t]}}}),Object.defineProperty(m.prototype,"get_a_color_usage",{get:function(){return function(t){return 0|this.pxl_colors_usage_[0|t]}}}),Object.defineProperty(m.prototype,"get_a_new_pxl_color",{get:function(){return function(t){return this.new_pxl_colors_.get_element(0|t)}}}),Object.defineProperty(m.prototype,"max_cluster",{get:function(){return 0|this.max_cluster_}}),Object.defineProperty(m.prototype,"threshold_steps",{get:function(){return 0|this.threshold_steps_}}),Object.defineProperty(m.prototype,"new_pxls_length",{get:function(){return 0|this.new_pxls_.length}}),Object.defineProperty(m.prototype,"new_pxl_colors_length",{get:function(){return 0|this.new_pxl_colors_.length}}),Object.defineProperty(m.prototype,"best_color_number",{get:function(){return 0|this.best_color_number_}}),Object.defineProperty(m.prototype,"bucket_threshold",{get:function(){return 0|this.bucket_threshold_}}),Object.defineProperty(m.prototype,"is_bucket_threshold_auto",{get:function(){return 0|this.is_bucket_threshold_auto_}}),Object.defineProperty(m.prototype,"set_bucket_threshold",{get:function(){return function(t){this.bucket_threshold_=0|t}}}),Object.defineProperty(m.prototype,"get_data",{get:function(){return function(){return Array.of(this.new_pxls_,this.new_pxl_colors_.slice_uint32(0,this.new_pxl_colors_.length))}}}),m.prototype.deduplicate=function(){this.reset_deduplicate(0|this.new_pxl_colors_length);for(var t=0,e=0,r=0,n=0;(0|n)<(0|this.new_pxls_length);n=(n+1|0)>>>0)e=0|this.get_a_new_pxl_color_from_pxl_index(0|n),-1==(0|(r=0|this.index_of_color_within_cleaned(0|e)))&&(this.set_cleaned_pxl_colors(0|t,0|e),r=0|t,t=t+1|0),this.increase_color_usage(0|r),this.set_new_pxls(0|n,0|r);this.set_new_pxl_colors(t)},m.prototype.clusterize=function(){this.reset_cluster();var t=0;if(4097===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon12bits)>>>0,(0|t)>>>0);else if(257===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon8bits)>>>0,(0|t)>>>0);else if(17===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon4bits)>>>0,(0|t)>>>0);else if(1===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster(0,(0|t)>>>0);this.set_all_cluster_indexes()},m.prototype.process_threshold=function(t){t=(0|t)>>>0;for(var e,r,n,o,_=this.bucket_threshold*(t/this.threshold_steps)|0,i=Math.fround(t/this.threshold_steps),s=new Set,u=new Set,l=0,h=0,c=0,a=0,p=!1,f=0,g=0,y=0,d=0,b=0,x=0,w=0;(0|w)<(0|this.max_cluster);w=(w+1|0)>>>0){for(h=(l+this.get_length_in_index_clusters(0|w)|0)>>>0,b=l;(0|b)<(0|h);b=(b+1|0)>>>0)if(y=(0|this.get_an_index_in_clusters((0|b)>>>0))>>>0,u.clear(),!s.has(0|y)){for(e=this.get_a_new_pxl_color((0|y)>>>0),c=(0|this.get_a_color_usage((0|y)>>>0))>>>0,0,x=(0|b)>>>0;(0|x)<(0|h);x=(x+1|0)>>>0)d=(0|this.get_an_index_in_clusters((0|x)>>>0))>>>0,s.has(0|d)||(r=this.get_a_new_pxl_color((0|d)>>>0),g=((_/255+_/255*(1-(f=255*((p=(0|c)>(0|(a=(0|this.get_a_color_usage((0|d)>>>0))>>>0)))?c/a:a/c)|0)/255)*i)/(1+i)*255|0)>>>0,e.euclidean_match_with(r,0|g)&&(s.add(y),s.add(d),u.add(r),e.blend_with(r,p?f:255-(f/255|0),!1,!1)));for(o=u.values(),n=0;(0|n)<(0|u.size);n=(n+1|0)>>>0)o.next().value.set(e)}l=0|h}return s.size>0},m.prototype.round=function(){if(this.new_pxl_colors_length>2048)for(var t=this.new_pxl_colors_length>8192?8:this.new_pxl_colors_length>4096?4:this.new_pxl_colors_length>2048?2:1,e=0;(0|e)<(0|this.new_pxl_colors_length);e=(e+1|0)>>>0)this.get_a_new_pxl_color((0|e)>>>0).simplify(0|t)},m.prototype.init=function(){return this.round(),this},m.prototype.run=function(){for(var t=!1,e=!0;!t;){for(var r=1;(0|r)<=(0|this.threshold_steps);r=(r+1|0)>>>0)e&&(this.deduplicate(),this.clusterize()),e=this.process_threshold(0|r);this.new_pxl_colors_length<this.best_color_number||!this.is_bucket_threshold_auto?t=!0:this.new_pxl_colors_length>this.best_color_number&&this.set_bucket_threshold(this.bucket_threshold+1|0)}return this.get_data()},new Promise((function(i){for(var s=new Uint32Array(t.data.slice(0,t.data.length).reverse().buffer).reverse(),u=0,l=new Uint32Array(s.length),h=new Uint32Array(s.length),c=0,a=0;(0|a)<(0|s.length);a=(a+1|0)>>>0)-1===(c=l.indexOf(s[a]))&&(l[u]=0|s[a],c=0|u,u=u+1|0),h[a]=0|c;l=l.slice(0,u);var p=m({pxls:h,pxl_colors:l,bucket_threshold:e,threshold_steps:r,color_number_bonus:n,best_color_number:o,this_state_bucket_threshold:_}).init().run(),f=p[0],g=p[1];h=new Uint32Array(p[0].length);for(a=0;(0|a)<(0|h.length);a=(a+1|0)>>>0)h[a]=0|g[f[a]];t.data.set(new Uint8ClampedArray(h.reverse().buffer).reverse()),i(t)}))};`
    + "return t;")();

const quanti_mat = (imagedata, limit, callback_function = () => {}, pool = null) => {

    /*
    if(pool !== null) {

        pool.exec(window.quant_process_function, [
            imagedata, limit
        ]).catch((e) => {

            return window.quant_process_function(imagedata, limit);
        }).timeout(15 * 1000).then((r)=> {

            callback_function(r);
        });

    }else {

        window.quant_process_function(imagedata, limit).then((r)=> {

            callback_function(r);
        });
    }
    */

    QuantiMatGlobal(imagedata, limit).then(callback_function)
};

module.exports = { quanti_mat }